<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bidly ‚Ä¢ Login</title>

    <!-- CSS principal -->
    <link rel="stylesheet" href="/assets/css/base.css" />

    <!-- Gradiente headline -->
    <style>
      .tagline-hero .txt-gradient { text-shadow: none !important; }
      .tagline .txt-gradient,
      .tagline-hero .txt-gradient,
      .txt-gradient{
        background-image: linear-gradient(90deg, #8bd0ff 0%, #74a9ff 52%, #b69cff 100%) !important;
        background-repeat: no-repeat !important;
        background-size: 100% 100% !important;
        -webkit-background-clip: text !important;
        background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        color: transparent !important;
        display: inline-block !important;
        position: relative !important;
        z-index: 1 !important;
      }
    </style>

    <!-- Fallback de seguran√ßa -->
    <style>
      .hide { display: none !important; }
    </style>

    <!-- PR√â-AUTH: oculta o que pisca antes da sess√£o ser resolvida -->
    <style>
      /* enquanto o body tiver .auth-boot, escondemos tudo que pode ‚Äúpiscar‚Äù */
      body.auth-boot [data-login-card] { display: none !important; }
      body.auth-boot [data-auth]       { visibility: hidden !important; }
      body.auth-boot #ctaContinue      { display: none !important; }
    </style>

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400..900&family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>

  <!-- >>> ADICIONAMOS auth-boot para impedir flash de login <<< -->
  <body class="wrap has-topbar auth-boot">
    <!-- ====================== TOPBAR FIXA ====================== -->
    <header class="topbar">
      <div class="container">
        <!-- Marca -->
        <a class="brand" href="/index.html" aria-label="Bidly">
          <span class="logo"></span>
          <span>Bidly</span>
        </a>

        <!-- Navega√ß√£o (mesma p√°gina) -->
        <nav class="nav-desktop" aria-label="Principal">
          <a href="#beneficios">Benef√≠cios</a>
          <a href="#como-funciona">Como funciona</a>
          <a href="#precos">Pre√ßos</a>
          <a href="#faq">FAQ</a>
        </nav>

        <!-- A√á√ïES (mostra s√≥ quando logado) -->
        <div class="actions">
          <span class="muted hide" data-auth>
            Logado como: <b id="userEmail">‚Äî</b>
          </span>
          <a href="/app/" id="btnGoApp" class="btn hide" data-auth>Ir para app</a>
          <button id="btnOutTop" class="btn ghost hide" data-auth>Sair</button>

          <!-- hamburger -->
          <button
            class="menu-toggle"
            aria-expanded="false"
            aria-label="Abrir menu"
          >
            <span></span><span></span><span></span>
          </button>
        </div>
      </div>

      <!-- Menu m√≥vel -->
      <div class="mobile-menu" aria-hidden="true">
        <nav aria-label="Menu m√≥vel">
          <a href="#beneficios" class="mm-link">Benef√≠cios</a>
          <a href="#como-funciona" class="mm-link">Como funciona</a>
          <a href="#precos" class="mm-link">Pre√ßos</a>
          <a href="#faq" class="mm-link">FAQ</a>
        </nav>
      </div>
    </header>
    <!-- ==================== /TOPBAR FIXA ==================== -->

    <!-- Headline -->
    <h1><span class="badge">üîê</span> Bidly</h1>

    <!-- DESKTOP -->
    <p class="tagline tagline--desktop">
      <span class="tagline-hero">
        Conecta Empresas com <span class="txt-gradient">Hunters e Recrutadores</span>.
      </span>
      <span class="tagline-sub">
        Empresa define o Perfil | Hunters e Recrutadores | Candidato Ideal.<br />
        Agilidade, Menor Custo e Transpar√™ncia.
      </span>
    </p>

    <!-- MOBILE -->
    <p class="tagline tagline--mobile">
      <span class="tagline-hero">
        Conecta empresas com <span class="txt-gradient">Headhunters e Recrutadores</span>.
      </span>
      <span class="tagline-sub">
        Empresa define o Perfil | Hunters e Recrutadores | Candidato Ideal.<br />
        Agilidade, Menor Custo e Transpar√™ncia.
      </span>
    </p>

    <!-- ===== Card de login (isolado) ===== -->
    <div id="loginWrap">
      <div class="card login-card" data-login-card>
        <!-- ...aqui dentro ficam as portas e os campos... -->
        <div class="role-portas">
          <button class="btn outline" data-role="company" id="btnRoleCompany" aria-pressed="false">Sou Empresa</button>
          <button class="btn outline" data-role="vendor"  id="btnRoleVendor"  aria-pressed="false">Sou Fornecedor</button>
        </div>

        <input type="hidden" id="role" value="">

        <div class="form-field">
          <input id="email" type="email" placeholder="Seu e-mail" />
        </div>
        <div class="form-field">
          <input id="password" type="password" placeholder="Sua senha" />
        </div>

        <div class="form-actions">
          <button id="btnSignIn" class="btn">Entrar</button>
          <button id="btnSignUp" class="btn outline" disabled aria-disabled="true">Criar conta</button>
        </div>

        <div class="form-links">
          <a id="lnkForgot"  href="#" class="muted">Esqueci minha senha</a>
          <a id="lnkResend" href="#" class="muted">Reenviar e-mail de confirma√ß√£o</a>
        </div>

        <small id="authMsg" class="muted"></small>
      </div>
    </div>

    <!-- CTA mostrado SOMENTE quando j√° estiver logado -->
    <p id="ctaContinue" class="hide" style="text-align: center; margin-top: 12px">
      <a class="btn" href="/app/">Continuar na app</a>
    </p>

    <!-- ============================ SCRIPTS (ORDEM IMPORTA) ============================ -->
    <!-- 1) Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>

    <!-- 2) N√∫cleo unificado -->
    <script src="/assets/js/supa.js?v=1"></script>

    <!-- 3) L√≥gica do formul√°rio -->
    <script src="/assets/js/auth.js?v=1"></script>

    <!-- Remove badge do CodeSandbox -->
    <script>
      const hideCSBBadge = () => {
        document
          .querySelectorAll(
            '#sb__open-sandbox, .csb-portal, iframe[title="Open Sandbox"], button[aria-label="Open Sandbox"], [data-csb-overlay]'
          )
          .forEach((el) => el.remove());
      };
      hideCSBBadge();
      new MutationObserver(hideCSBBadge).observe(document.body, {
        childList: true,
        subtree: true,
      });
    </script>

    <!-- Sombra na topbar ao rolar -->
    <script>
      (function () {
        const topbar = document.querySelector(".topbar");
        if (!topbar) return;
        const onScroll = () =>
          topbar.classList.toggle("is-scrolled", window.scrollY > 4);
        onScroll();
        window.addEventListener("scroll", onScroll, { passive: true });
      })();
    </script>

    <!-- Menu m√≥vel -->
    <script>
      (function () {
        const btn = document.querySelector(".menu-toggle");
        const mobile = document.querySelector(".mobile-menu");
        if (!btn || !mobile) return;

        const open = () => {
          document.body.classList.add("menu-open");
          btn.classList.add("is-open");
          btn.setAttribute("aria-expanded", "true");
          mobile.setAttribute("aria-hidden", "false");
        };
        const close = () => {
          document.body.classList.remove("menu-open");
          btn.classList.remove("is-open");
          btn.setAttribute("aria-expanded", "false");
          mobile.setAttribute("aria-hidden", "true");
        };
        const toggle = () =>
          document.body.classList.contains("menu-open") ? close() : open();

        btn.addEventListener("click", toggle);
        mobile.addEventListener("click", (e) => {
          if (e.target.classList.contains("mm-link")) close();
        });
        window.addEventListener("keyup", (e) => {
          if (e.key === "Escape") close();
        });
        window.addEventListener("resize", () => {
          if (window.innerWidth > 900) close();
        });
      })();
    </script>

    <!-- Boot + UX reativa (sem abrir nova aba; sem auto-redirect) -->
    <script>
      (async () => {
        try {
          // 1) Conecta + aplica UI base
          await connectSupabase();
          await applyAuthUI();

          // 2) Seletores locais
          const marketingLinks = Array.from(
            document.querySelectorAll(".nav-desktop a, .mobile-menu .mm-link")
          );
          const loginCard = document.querySelector("[data-login-card]");
          const cta = document.getElementById("ctaContinue");
          const brand = document.querySelector(".brand");

          // 3) Estado global
          let isLogged = false;

          // 4) Atualiza comportamento conforme sess√£o
          const updateUX = (session) => {
            isLogged = !!session;

            // links SEMPRE mesma aba
            marketingLinks.forEach((a) => {
              a.removeAttribute("target");
              a.removeAttribute("rel");
            });

            if (loginCard) loginCard.classList.toggle("hide", isLogged);
            if (cta) cta.classList.toggle("hide", !isLogged);

            // >>>>>> ACABOU o boot: remove pr√©-auth (elimina ‚Äúflash de login‚Äù)
            document.body.classList.remove("auth-boot");
          };

          // 5) Estado inicial
          const { data } = await sb.auth.getSession();
          updateUX(data?.session || null);

          // 6) Mudan√ßas de sess√£o
          sb.auth.onAuthStateChange?.((_e, session) => updateUX(session || null));

          // 7) Sair (topo)
          const doLogout = async () => {
            try { await logoutLocal(); } catch {}
            location.href = "/index.html";
          };
          document.getElementById("btnOutTop")?.addEventListener("click", doLogout);

          // 8) Clique no logo (persist√™ncia de sess√£o na navega√ß√£o)
          brand?.addEventListener("click", (e) => {
            if (isLogged) { e.preventDefault(); location.href = "/app/"; }
          });

          // 9) CTA "Continuar na app"
          cta?.addEventListener("click", (e) => {
            e.preventDefault();
            location.href = "/app/";
          });

        } catch (e) {
          console.error("[index boot]", e);
          // Libera layout mesmo em erro pra n√£o travar a p√°gina
          document.body.classList.remove("auth-boot");
        }
      })();
    </script>

    <!-- BLOCO que cuida do estado visual do bot√£o ‚ÄúCriar conta‚Äù + mensagens -->
    <script>
      (function () {
        const roleBtns   = Array.from(document.querySelectorAll(".role-portas [data-role]"));
        const btnSignUp  = document.getElementById("btnSignUp");
        const authMsg    = document.getElementById("authMsg");
        const roleHidden = document.getElementById("role");
        const btnSignIn  = document.getElementById("btnSignIn");
        if (!btnSignUp || roleBtns.length === 0) return;

        const setMsg = (text, kind) => {
          if (!authMsg) return;
          authMsg.textContent = text || "";
          authMsg.classList.remove("error","success");
          if (kind) authMsg.classList.add(kind);
        };

        const validRole = r => r === "company" || r === "vendor";

        const markActive = (role) => {
          roleBtns.forEach((b) => {
            const isActive = b.dataset.role === role;
            b.classList.toggle("is-active", isActive);
            b.setAttribute("aria-pressed", String(isActive)); // acessibilidade
          });
          if (roleHidden) roleHidden.value = role; // sincroniza o hidden #role
        };

        // >>> FIX: controlar tamb√©m o atributo [disabled]
        const setVisuallyDisabled = (flag) => {
          const disabled = !!flag;
          btnSignUp.classList.toggle("is-disabled", disabled);
          btnSignUp.setAttribute("aria-disabled", disabled ? "true" : "false");
          if (disabled) btnSignUp.setAttribute("disabled", "disabled");
          else btnSignUp.removeAttribute("disabled");
        };

        setVisuallyDisabled(true); setMsg("");

        // Pr√©-seleciona pela URL, se houver
        try {
          const urlRole = new URLSearchParams(location.search).get("expectedRole");
          if (validRole(urlRole)) {
            markActive(urlRole);
            setVisuallyDisabled(false);
            setMsg(`Criar conta como ${urlRole === "company" ? "Empresa" : "Fornecedor"}.`);
          }
        } catch {}

        // Clique nas portas
        roleBtns.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const role = btn.dataset.role;
            if (!validRole(role)) return;
            markActive(role);
            setVisuallyDisabled(false);
            setMsg(`Criar conta como ${role === "company" ? "Empresa" : "Fornecedor"}.`);
            try { localStorage.setItem("expectedRole", role); } catch {}
            try {
              const url = new URL(location.href);
              url.searchParams.set("expectedRole", role);
              history.replaceState({}, "", url);
            } catch {}
          });
        });

        btnSignUp.addEventListener("click", (e) => {
          const disabled =
            btnSignUp.classList.contains("is-disabled") ||
            btnSignUp.getAttribute("aria-disabled") === "true" ||
            btnSignUp.hasAttribute("disabled");
          if (disabled) {
            e.preventDefault();
            setMsg('Selecione um card: "Sou Empresa" ou "Sou Fornecedor" para criar sua conta.', "error");
          }
        }, true);

        // Entrar ‚Üí bloqueia se n√£o houver papel definido (UX)
        btnSignIn?.addEventListener("click", (e) => {
          const role =
            (document.getElementById('role')?.value) ||
            (new URLSearchParams(location.search).get("expectedRole")) ||
            (localStorage.getItem("expectedRole") || "");

          if (role !== "company" && role !== "vendor") {
            e.preventDefault();
            const authMsg = document.getElementById("authMsg");
            if (authMsg) {
              authMsg.classList.remove("success","ok");
              authMsg.classList.add("error");
              authMsg.textContent = 'Selecione "Sou Empresa" ou "Sou Fornecedor" antes de entrar.';
            }
          }
        }, true);
      })();
    </script>

  </body>
</html>
